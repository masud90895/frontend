"use strict";(self.webpackChunk_metafox_react=self.webpackChunk_metafox_react||[]).push([["metafox-admincp-blocks-AdminChartStats-Block"],{8776:function(e,t,a){a.r(t),a.d(t,{default:function(){return j}});var l=a(43961),n=a(1530),r=a(30758),i=a(73821),o=a(78407),s=a(69508),u=a(99221),d=a(32367),c=a(12599),m=a(24716),p=a(97276),g=a(41042),f=a.n(g),h=a(97266),v=a.n(h),y=a(67194),b=a.n(y),k=a(18402),A=a.n(k),E=a(8622),w=a.n(E),C=a(20644),x=a.n(C),_=a(56588),M=a.n(_),S=a(21658),B=a.n(S);i.t1.register(i.PP,i.kc,i.FN,i.No,i.hE,i.m_,i.s$);let $=(0,s.Ay)(n.tD,{slot:"BlockContent"})(({theme:e})=>({height:"100%",display:"flex",flexDirection:"column",justifyContent:"space-between"})),D=(0,s.Ay)("div",{slot:"HeaderWrapper"})(({theme:e})=>({display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:e.spacing(3),[e.breakpoints.down("lg")]:{flexDirection:"column"}})),W=(0,s.Ay)("div",{slot:"HeaderLeftWrapper"})(({theme:e})=>({height:"auto",[e.breakpoints.down("lg")]:{marginBottom:e.spacing(2)}})),H=(0,s.Ay)("div",{slot:"HeaderRightWrapper"})(({theme:e})=>({height:"auto","& .MuiSelect-select":{paddingTop:e.spacing(1),paddingBottom:e.spacing(1)}})),z=(0,s.Ay)("h3",{slot:"TitleHeader"})(({theme:e})=>({fontSize:e.spacing(2.5),margin:e.spacing(0),fontWeight:"normal"})),L=(0,s.Ay)("span",{slot:"Time"})(({theme:e})=>({color:e.palette.grey[700],height:e.spacing(2),display:"block"})),N=(0,s.Ay)("div",{slot:"Chart"})(({theme:e})=>({color:e.palette.grey[700],position:"relative",flex:1,minHeight:0,"&.loading canvas":{opacity:.1}})),P=(0,s.Ay)(u.A,{slot:"Loading"})(({theme:e})=>({height:"100%",width:"100%",justifyContent:"center",display:"flex",position:"absolute"})),T={},V="admincp_chart_stats_period",Y="admincp_chart_stats_type";var j=(0,l.WvA)({extendBlock:function(e){var t,a,i;let{useFetchDetail:s,apiClient:u,jsxBackend:g,i18n:h,useTheme:y,cookieBackend:k}=(0,l.PCX)(),[E,C]=r.useState({data:[]}),[_,S]=r.useState(k.get(Y)||"user"),[j,R]=r.useState(k.get(V)||"1d"),[F,I]=r.useState(!0),O=y(),q=r.useRef(null),U=(0,l.wVH)(),[X]=s({dataSource:{apiUrl:"admincp/dashboard/stat-type"}}),Z=(null==X||null==(t=X.types)?void 0:t.find(e=>e.value===_))||{},G=r.useCallback(async(e,t)=>{if(q.current&&q.current.abort(),T[`${e}_${t}`]){C(T[`${e}_${t}`]),I(!1);return}q.current=new AbortController;let a=q.current.signal;I(!0);try{let s=await u.request({method:"get",url:`admincp/dashboard/chart?name=${e}&period=${t}`,signal:a});if(s){var l,n,r,i,o;let a={data:null==s||null==(l=s.data)?void 0:l.data,from:null==s||null==(r=s.data)||null==(n=r.meta)?void 0:n.from,to:null==s||null==(o=s.data)||null==(i=o.meta)?void 0:i.to};T[`${e}_${t}`]=a,C(a),I(!1)}}catch(e){}},[u]);(0,r.useEffect)(()=>{G(_,j)},[]);let J=r.useCallback((e,t)=>{let a=null!=t?t:j;return"1d"===a?B()(e).format("DD MMM"):"1w"===a?(B()().week()===B()(e).week()?B()():B()(e).endOf("week")).format("DD MMM"):"1M"===a?B()(e).format("MMM YYYY"):void 0},[j]),K=r.useCallback((e,t,a)=>{let l;if(!t||!a)return e.sort((e,t)=>B()(e.time).unix()-B()(t.time).unix());let n=[],r=B()(t),i=(l=null,"1d"===j&&(l="day"),"1w"===j&&(l="week"),"1M"===j&&(l="month"),l);for(;r.isSameOrBefore(a,i);){let t=J(r),a=e.find(e=>e.label===t);n.push(a||{label:t,data:0}),r.add(1,i)}return n},[j,J]),Q=f()(null==E?void 0:E.data,({date:e})=>J(e)),{labels:ee,dataValues:et}=K(b()(Q,(e,t)=>{var a;return{label:t,data:((e,t,a="data")=>t?"sum"===e?w()(t,a):"min"===e?M()(t.map(e=>x()(e,a))):"max"===e?A()(t.map(e=>x()(e,a))):w()(t,a):0)(Z.operation,e,"data"),time:null==(a=v()(e))?void 0:a.date}}),null==E?void 0:E.from,null==E?void 0:E.to).reduce((e,t)=>(e.labels.push(t.label),e.dataValues.push(t.data),e),{labels:[],dataValues:[]}),ea={labels:ee,datasets:[{data:et,borderColor:O.palette.primary.main,backgroundColor:O.palette.primary.main}]},el={responsive:!0,maintainAspectRatio:!1,clip:!1,plugins:{legend:!1,title:{display:!1}},scales:{y:{beginAtZero:!0,min:0,ticks:{stepSize:parseInt(A()(et),10)>50?10:1}}}};return r.createElement(n.eB,null,r.createElement($,null,r.createElement(D,null,r.createElement(W,null,r.createElement(z,null,h.formatMessage({id:"welcome_back_username"},{username:U.user.full_name})),r.createElement(L,null,F?null:r.createElement(r.Fragment,null,ee[0]," - ",ee[ee.length-1]," "))),r.createElement(H,null,r.createElement(d.A,{sx:{m:1,minWidth:200},size:"small"},r.createElement(c.A,null,h.formatMessage({id:"type"})),r.createElement(m.A,{value:_,label:"Type",onChange:e=>{let t=e.target.value;S(t),k.set(Y,t),G(t,j)}},null==X||null==(a=X.types)?void 0:a.map((e,t)=>r.createElement(p.A,{key:t,value:e.value},e.label)))),r.createElement(d.A,{sx:{m:1,minWidth:200},size:"small"},r.createElement(c.A,null,h.formatMessage({id:"view"})),r.createElement(m.A,{value:j,label:"View",onChange:e=>{let t=e.target.value;R(t),k.set(V,t),G(_,t)}},null==X||null==(i=X.period)?void 0:i.map((e,t)=>r.createElement(p.A,{key:e.value,value:e.value},e.label)))))),r.createElement(N,{className:F?"loading":""},F?r.createElement(P,null,g.render({component:"form.DefaultLoading"})):r.createElement(o.N1,{width:500,data:ea,options:el}))))},defaults:{title:"Chart",blockLayout:"Admin - Block - Contained",blockProps:{blockStyle:{sx:{height:"calc(100% - 16px)"}}}}})}}]);